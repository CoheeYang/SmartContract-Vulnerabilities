

## eBPF与sBPF

1. eBPF

**eBPF 是一个运行在 Linux 内核内部的、安全的、高效的虚拟机。**你可以把它想象成一种“内核超级插件系统”。它允许开发者在不需要修改内核源代码或编译加载内核模块的情况下，动态地将自定义的程序“注入”到内核中运行。其设计目的在于**安全、动态地扩展OS内核功能**

**核心思想：** 传统上，如果你想在内核中增加新功能（比如新的网络过滤规则、新的性能监控指标），你需要编写一个内核模块，这有很高的技术门槛和风险（一个 Bug 就可能导致系统崩溃）。eBPF 改变了这一切。

**eBPF 的工作流程：**

1. **编写：** 开发者用一种类 C 的语言编写 eBPF 程序。
2. **编译：** 使用特殊的编译器（如 LLVM）将代码编译成 eBPF 字节码。
3. **验证：** 在加载到内核之前，一个名为“验证器”的内核组件会严格检查这段字节码。它会确保：
   - 程序不会崩溃或破坏内核。
   - 程序一定会结束（没有无限循环）。
   - 程序只能访问被授权的内存区域。
   - 这个安全检查步骤是 eBPF 安全性的基石。
4. **即时编译（JIT）：** 通过验证后，内核会将 eBPF 字节码即时编译成本地机器码，以达到近乎原生代码的执行效率。
5. **挂载：** 将编译好的程序挂载到内核的特定“钩子点”上。
6. **触发执行：** 当特定事件发生时（如网络数据包到达、系统调用被执行、函数被调用），内核就会触发并执行这些 eBPF 程序。

| 层级                | 技术示例               | 说明                                 |
| :------------------ | :--------------------- | :----------------------------------- |
| **应用软件**        | Chrome, MySQL          | 运行在用户空间的应用程序             |
| **中间件/框架**     | eBPF **程序**          | 用 eBPF 编写的具体功能，如网络过滤器 |
| **“虚拟机”/运行时** | eBPF **虚拟机/运行时** | Linux 内核中执行 eBPF 字节码的引擎   |
| **操作系统内核**    | Linux Kernel           | 操作系统的核心                       |
| **硬件指令集**      | **RISC-V**, x86, ARM   | CPU 能够直接执行的底层指令集         |
| **物理硬件**        | RISC-V 芯片, Intel CPU | 实际的物理处理器                     |



2. sBPF

[Blueshift | Introduction to Assembly | Registers and Memory](https://learn.blueshift.gg/zh-CN/courses/introduction-to-assembly/registers-and-memory)