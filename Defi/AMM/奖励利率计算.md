用户获得的奖励:

```solidity
	//用户余额* (rewardIndex - lastRewardIndex)
    function _earned(address account, address rewardToken) internal view returns (uint256) {
        return
            (_balances[account] * (rewardPerToken(rewardToken) - userRewardPerTokenPaid[rewardToken][account])) / Constants.WAD + rewards[rewardToken][account];
    }
    //（当前-上次更新）*r /currentTotalSupply
    //其中r =rewardDistributed/ rewardTokenData.rewardsDuration
      function rewardPerToken(address rewardToken) public view returns (uint256) {
        if (totalSupply == 0) {
            return rewardData[rewardToken].rewardPerTokenStored;
        }

        return
            rewardData[rewardToken].rewardPerTokenStored +
            ((block.timestamp - rewardData[rewardToken].lastUpdateTime) * rewardData[rewardToken].rewardRate) /
            totalSupply;
        //rewardPerTokenStored+（当前-上次更新）*r /currentTotalSupply
    }


	//
    

```



首先是发钱distribute函数：

即算出来每秒钟发多少钱（reward/duration）得到一个r

这个r除以当前的totalsupply就是此时，每一秒每个代币所得到多少钱r'

再乘以现在时间和用户的更新时间的差额（dt = block.timestamp - updateTime）

dt r'就是用户这段时间每个token得到的钱，再乘以其token总数就可以得到他一共拿多少钱。



